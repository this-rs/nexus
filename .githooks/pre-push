#!/usr/bin/env bash
# Pre-push hook â€” runs clippy and fmt checks before pushing.
# Prevents pushing code that doesn't pass linting or formatting.
#
# Install: git config core.hooksPath .githooks
# Or:      cp .githooks/pre-push .git/hooks/pre-push && chmod +x .git/hooks/pre-push

set -euo pipefail

echo "ğŸ” Pre-push checks running..."
echo ""

# Ensure cargo is available
if ! command -v cargo &> /dev/null; then
    if [ -f "$HOME/.cargo/env" ]; then
        source "$HOME/.cargo/env"
    else
        echo "âŒ cargo not found. Skipping pre-push checks."
        exit 0
    fi
fi

# 1. cargo fmt check
echo "ğŸ“ Checking formatting (cargo fmt --all --check)..."
if ! cargo fmt --all --check; then
    echo ""
    echo "âŒ Formatting check failed."
    echo "   Run 'cargo fmt --all' to fix formatting issues."
    exit 1
fi
echo "   âœ… Formatting OK"
echo ""

# 2. cargo clippy
echo "ğŸ“ Running clippy (cargo clippy --all-targets --all-features -- -D warnings)..."
if ! cargo clippy --all-targets --all-features -- -D warnings; then
    echo ""
    echo "âŒ Clippy check failed."
    echo "   Fix the warnings above before pushing."
    exit 1
fi
echo "   âœ… Clippy OK"
echo ""

echo "âœ… All pre-push checks passed!"
